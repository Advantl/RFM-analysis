# RFM-analysis  
"RFM-анализ клиентской базы аптечной сети"  

Table of Contents  

- [Business Problem](#business-problem)  
- [About Data](#about-data)  
- [Project Background](#project-background)  
- [Executive Summary](#executive-summary)  
- [Insights Deep-Dive](#insights-deep-dive)  
- [Recommendations and Next Steps](#recommendations-and-next-steps)  
- [Business Impact & ROI](#business-impact--roi)  
- [Technical Project Information](#technical-project-information)  
- [Tech Stack](#tech-stack)  
  
***

## Business Problem  
В условиях предстоящего снижения покупательской активности, вызванного сезонным спадом, перед аптечной сетью стоит задача оптимизации маркетинговых затрат. Компания располагает инструментом SMS-рассылок, однако использование его в массовом формате сопряжено с риском неоправданных расходов. В связи с этим возникает необходимость разработки механизма персонализированной коммуникации с клиентами. Суть задачи заключается в том, чтобы исключить из целевых кампаний покупателей с минимальной вовлечённостью (например, совершивших единичную и малозначимую покупку), и сосредоточить усилия на сегментах, обладающих высоким потенциалом увеличения среднего чека и вероятностью отклика на персональные предложения.  

## About Data
Набор данных предоставлен образовательной платформой Simulative в рамках Курса-симулятора «Аналитик данных» (ООО «АЙТИ РЕЗЮМЕ») https://simulative.ru/data-analyst.  
  
Датасет представляет собой реальные исторические данные о продажах сети из 8 региональных аптек, расположенных в различных районах города. Данные представлены за период с 2021-07-13 по 2022-06-09 включительно и состоят из 8 колонкок и 38486 строк. Вся необходимая для работы информация о транзакциях по бонусной системе содержится в таблице _bonuscheques_.  

| Column        | Description                        | Data Type          | 
| :------------ |:---------------------------------- |:------------------:|
| datetime      | Дата и время совершения транзакции |timestamp    |
| shop          | Название аптеки                    |varchar(20)  |
| card          | Номер бонусной карты               |varchar(100) |
| bonus_earned  | Количество начисленных бонусов     |int4         |
| bonus_spent   | Количество потраченных бонусов     |int4         |
| summ          | Сумма чека                         |int4         |
| summ_with_disc| Сумма чека с учетом скидок и списаний бонусов |int4 |
| doc_id        | Номер документа                     |varchar(100) |

## Project Background  
**Цель анализа.**  
Провести сегментацию клиентской базы аптечной сети с использованием RFM-анализа на основе частоты покупок (Frequency), давности последних заказов (Recency) и объёма трат (Monetary). Это позволит выявить ключевые группы покупателей, определить их ценность для бизнеса и разработать стратегию маркетингового воздействия для каждой группы.  

**Период.**  
Сегментация клиентской базы произведена за период с 2021-07-12 по 2022-06-09.  

**Пороговые значения для RFM-метрик:**  
*Recency* и *Monetary* - перцентили 25% и 75%.    
*Frequency* - фиксированные бизнес-пороги (1 покупка, 2-3 покупки, 4 и более).   
Выбор обусловлен особенностью распределения величины и реализован с целью собрать в одну группу всех клиентов, совершивших разовые покупки.

## Executive Summary  
В ходе анализа были выделены 8 основных сегментов и дополнительный сегмент (High-Frequency Buyers) с аномально высокой метрикой Frequency. 

**Массовые категории.**   
Массовые категории представлены **Promising (31%)**, **New Customers (13%)** и **Hibernating Customers (17%)** — перспективная основа для роста, требуют welcome-программ и персонализированного маркетинга.   
*New Customers* должны стать предметом особого внимания: правильная welcome-стратегия позволит перевести часть в сегменты Potential Loyalist и Loyal.   
*Hibernating Customers* имеют наименьший приоритет в плане маркетинговых инвестиций, но их реактивация может дать быстрый прирост оборота.  
  
**Основной вклад в выручку.**   
Основной вклад в выручку обеспечивают сегменты **Champions**, **Loyal** и **Cannot Lose Them**. 
Наибольшую ценность для бизнеса представляют сегменты *Champions* и *Loyal*, которые обеспечивают высокую выручку и стабильность.  
  
**Сегменты риска.**   
Сегменты риска представлены **At Risk (5%)** и **Cannot Lose Them (4%)** — небольшая, но стратегически важная группа, потеря приведёт к значительным убыткам. Нуждаются в реактивационных кампаниях, требуют приоритета в программах удержания, так как представляют собой клиентов с исторически высокой ценностью.   


## Insights Deep-Dive  

RFM Segmentation Plot.   
![RFM Segmentation Plot](https://github.com/Advantl/RFM-analysis/blob/main/rfm_categories.jpg)

   
RFM Segmentation Statistics.  

| rfm categories        | min recency | max recency | min frequency | max frequency | mean monetary | cnt |
|-----------------------|-------------|-------------|---------------|---------------|---------------|-----|
| Champions             | 1           | 186         | 4             | 13            | 6996          | 900 |
| Cannot Lose Them      | 188         | 332         | 1             | 12            | 4181          | 197 |
| Loyal                 | 1           | 187         | 2             | 10            | 3898          | 398 |
| Potential Loyalist    | 1           | 185         | 2             | 11            | 1769          | 507 |
| Promising             | 1           | 187         | 1             | 3             | 1541          | 1736|
| At Risk               | 188         | 327         | 2             | 3             | 1350          | 266 |
| Hibernating Customers | 188         | 333         | 1             | 1             | 881           | 955 |
| New Customers         | 1           | 187         | 1             | 1             | 414           | 731 |
     
     
-	**Champions (900 клиентов, средний чек 6996)**   
Самые ценные клиенты с высокой частотой и давностью покупок. Сегмент приносит наибольшую выручку. Требует удержания через персональные программы лояльности и VIP-сервисы.  
  
-	**Cannot Lose Them (197 клиентов, средний чек 4181)**   
Клиенты, которые ранее приносили значительную ценность, но давно не совершали покупки. Важный сегмент для реанимации через персональные предложения и ре-активационные кампании.  
  
-	**Loyal (398 клиентов, средний чек 3898)**   
Стабильная база, демонстрирующая регулярные покупки, но без экстремально высоких чеков. Перспективен для увеличения среднего чека через кросс- и апселл.  
  
-	**Potential Loyalist (507 клиентов, средний чек 1769)**   
Клиенты с недавними покупками и частотой выше разовой. Имеют высокий потенциал роста при правильном сопровождении.  
  
-	**Promising (1736 клиентов, средний чек 1541)**   
Самый массовый сегмент. Клиенты проявляют интерес, но пока приносят ограниченную ценность. Важен как основа для nurture-кампаний.  
  
-	**At Risk (266 клиентов, средний чек 1350)**   
Ранее активные, но переставшие совершать покупки. Сегмент требует анализа причин оттока и таргетированных акций по возвращению.  
  
-	**Hibernating Customers (955 клиентов, средний чек 881)**   
Клиенты с низкой частотой и давностью покупок, приносят минимальную ценность. Могут обслуживаться через недорогие массовые коммуникации.  
  
-	**New Customers (731 клиентов, средний чек 414)**   
Новые клиенты с разовыми покупками. Требуют «обучения» продукту и вовлечения для перехода в более ценные сегменты.  
  
  
**Аномальный сегмент (High-Frequency Buyers)**  
В ходе анализа была выделена небольшая группа клиентов с аномально высокой метрикой *Frequency* (количество покупок значительно превышает верхний квартиль распределения).

  - Доля таких клиентов в базе незначительна, однако они демонстрируют поведение, нетипичное для основной массы покупателей.  
  -  Возможные объяснения: корпоративные закупки, сбои в учёте, ошибки идентификации карт или крайне высокая индивидуальная лояльность.
  -  Данный сегмент был выделен отдельно, так как его присутствие искажает распределения и может приводить к неверным выводам в рамках классического RFM-анализа.  

**Рекомендация:** провести дополнительный анализ транзакций этих клиентов, проверить их корректность и определить, относятся ли они к целевой аудитории или это технические записи. В случае подтверждения уникальности — разработать отдельные механики работы (VIP-программы или спецобслуживание).
    
   
  
## Recommendations and Next Steps

На основании проведённого RFM-анализа были выделены ключевые клиентские сегменты. Для каждого сегмента определена его ценность для бизнеса, сформулированы приоритетные вопросы и предложены маркетинговые/CRM-мероприятия.  

| Сегмент              | Значение для бизнеса                     | Бизнес-вопросы                                                                 | Маркетинг / CRM                                                                 |
|-----------------------|------------------------------------------|---------------------------------------------------------------------------------|----------------------------------------------------------------------------------|
| **Champions** (333, 233) <br> Совсем недавно покупали, делают это часто, приносят наибольшую ценность (высокий *Monetary*). | Лучшие клиенты, «золотой фонд».            | Как удержать самых ценных клиентов? <br> Можем ли увеличить их пожизненную ценность (LTV)? | Персональные бонусы, VIP-программы, ранний доступ к акциям, реферальные программы. |
| **Loyal** (332, 331, 223, 323) <br> Часто покупают, но не всегда недавно или не всегда с высоким чеком. | Надёжная база клиентов.                    | Как закрепить лояльность и повысить средний чек?                                 | Кросс-селл, апселл, клуб постоянных клиентов, скидки на пакетные покупки.          |
| **Potential Loyalist** (322, 232, 231) <br> Недавно начали покупать, проявляют интерес, имеют потенциал стать постоянными. | Целевая группа для nurture-кампаний.       | Как превратить их в лояльных? <br> Есть ли барьеры для частых покупок?            | Триггерные рассылки, welcome-программы, персонализированные рекомендации.          |
| **New Customers** (311, 211) <br> Недавно совершили первую покупку, но пока без частоты и большой ценности. | Клиентов данного сегмента важно перевести в категорию лояльных. | Как вовлечь новых клиентов, чтобы они вернулись? | Приветственные бонусы, onboarding-кампании, push/email с напоминаниями. |
| **Promising** (221, 321, 313, 312, 222, 213, 212) <br> Покупали недавно, но нечасто и не на большие суммы. | Клиенты с низкой ценностью, но у которых есть шанс развиться. | Стоит ли тратить маркетинг-бюджет на удержание? | Недорогие акции, массовые рассылки, предложение скидки для повторной покупки. |
| **At Risk** (131, 122, 121) <br> Раньше покупали хорошо, но уже давно не возвращались. | Потеря ценных клиентов. | Почему ушли? Как вернуть тех, кто раньше покупал часто/много? | Персональные предложения, скидки на любимые товары, реактивационные кампании. |
| **Cannot Lose Them** (133, 132, 113, 123) <br> Когда-то были «Champions», но давно не покупали. | Очень важные клиенты, риск потерять лучших. | Почему пропали ценные клиенты? Как вернуть их быстрее всего? | Сильные персональные стимулы (спец. предложения, call-центр, премиальные скидки). |
| **Hibernating** (112, 111) <br> Давно не покупали, низкая частота и сумма | Наименее ценные клиенты. | Нужно ли вообще тратить бюджет на этих клиентов? | Дешёвые массовые каналы (email-рассылки), напоминания, push, но с ограничением затрат. |

## Business Impact & ROI  
### Цель оценки  
Целью данного этапа анализа является оценка потенциального экономического эффекта от внедрения RFM-сегментации и проведения таргетированных маркетинговых коммуникаций в виде SMS-рассылок.  

Оценка выполнена в формате сценарного моделирования и отражает ожидаемый инкрементальный эффект, а не фактические результаты маркетинговых кампаний.  

### Методология оценки  
В качестве основного канала воздействия рассматриваются персонализированные SMS-кампании, так как данный инструмент доступен компании и позволяет гибко таргетировать коммуникации по RFM-сегментам.  

Для каждого сегмента был выбран один ключевой рычаг воздействия:  
- рост среднего чека (AOV),  
- увеличение частоты покупок,  
- реактивация клиентов.  

Для расчётов использованы:  
- историческое среднее значение чека (Monetary),  
- размер сегмента,  
- консервативные гипотезы uplift, соответствующие типовым бенчмаркам CRM-маркетинга в ритейле.

### Сегменты и гипотезы воздействия  
В рамках оценки были выделены 5 сегментов с наибольшим потенциалом возврата инвестиций:  
| Сегмент            | Тип воздействия                   | Гипотеза                  |  
| ------------------ | --------------------------------- | ------------------------- |  
| Champions          | Upsell / персональные предложения | +5% к AOV                 |  
| Loyal              | Cross-/upsell                     | +7% к AOV                 |  
| Potential Loyalist | Nurture-кампании                  | +1 покупка у 20% клиентов |  
| Cannot Lose Them   | Реактивация                       | 12% клиентов вернутся     |  
| At Risk            | Реактивация                       | 7% клиентов вернутся      |  

Сегменты New Customers и Hibernating Customers исключены из активных инвестиций в рамках данного сценария из-за низкого среднего чека и высокой неопределённости отклика.  
В условиях ограниченного маркетингового бюджета целесообразно тестировать сегмент Promising отдельно, после подтверждения эффективности кампаний на более ценных сегментах.  

### Оценка потенциального прироста выручки  
Расчёт дополнительной выручки производился по следующим формулам:  

Для роста AOV:  
- ΔRevenue = Clients × Mean Monetary × Uplift  

Для роста частоты и реактивации:  
- ΔRevenue = Clients × Share Affected × Mean Monetary × Additional Purchases  

### Итоговая оценка эффекта
| Сегмент            | Клиенты | Ожидаемый эффект, ₽ |
| ------------------ | ------- | ------------------- |
| Champions          | 900     | ~315 000            |
| Loyal              | 398     | ~108 000            |
| Potential Loyalist | 507     | ~179 000            |
| Cannot Lose Them   | 197     | ~99 000             |
| At Risk            | 266     | ~25 000             |
| **Итого**          |         | **~726 000**        |

Даже при консервативных предположениях модель демонстрирует существенный потенциал прироста выручки за анализируемый период.  
Потенциальный рост выручки составляет ~5.3% без привлечения нового трафика, исключительно за счёт изменения поведения текущей клиентской базы.  
Даже частичная реализация сценария (50% от оценочного uplift) обеспечит рост выручки на ~2.5%, что подтверждает устойчивость эффекта.  

### Маркетинговые издержки  
Для оценки затрат использованы следующие допущения:  
- стоимость одного SMS — 2 ₽,  
- 1 SMS для upsell-кампаний,  
- 2 SMS для nurture- и реактивационных кампаний.  
Оценка совокупных затрат:  
| Тип кампании                            | Оценка затрат, ₽ |  
| --------------------------------------- | ---------------- |  
| Upsell (Champions, Loyal)               | ~2 600           |  
| Nurture (Potential Loyalist)            | ~2 000           |  
| Реактивация (Cannot Lose Them, At Risk) | ~1 300           |  
| **Итого**                               | **~5 900**       |  

### ROI и бизнес-выводы   
При ожидаемом приросте выручки ~726 тыс. ₽ и маркетинговых затратах ~6 тыс. ₽:  
- ROI кампаний является кратно положительным,  
- основной вклад в эффект обеспечивают сегменты Champions, Loyal и Potential Loyalist,  
- RFM-сегментация позволяет перераспределить маркетинговые бюджеты в пользу наиболее ценных клиентов и отказаться от массовых неэффективных коммуникаций.

**Contribution chart: вклад сегментов в рост**    
Более 80% ожидаемого прироста формируется за счёт 3 сегментов, что позволяет оптимизировать маркетинговые затраты без потери эффекта.  
![RFM Contribution chart](https://github.com/Advantl/RFM-analysis/blob/main/rfm_contribution_chart.png)

### Ограничения и дальнейшие шаги   
Оценка эффекта основана на сценарных допущениях и не учитывает влияние других возможных факторов (сезонность, офлайн-активности, внешние события).

Для получения точной инкрементальной оценки рекомендуется:  
- проведение A/B-тестов с контрольной группой,  
- тестирование различных креативов и частоты SMS,  
- последующий пересмотр uplift-гипотез на основе фактических данных.  

## Technical Project Information 
* [Exploratory Data Analysis](https://github.com/Advantl/RFM-analysis/blob/main/rfm_eda.ipynb)  
*	[Пошаговая разработка SQL-скрипта с комментариями](https://github.com/Advantl/RFM-analysis/blob/main/rfm_sql_script_development.ipynb)    
*	[Итоговый SQL-скрипт.](https://github.com/Advantl/RFM-analysis/blob/main/rfm_analysis_sql_script.sql)  
*	[Визуализация RFM-сегментации в Metabase](https://metabase.simulative.ru/public/question/7201f450-fbbd-4713-9c63-5eb4c234bf9a)  
* [Оценка потенциального экономического эффекта RFM-сегментации]()  

## Tech stack 
Python:  
- Data Manipulation & Analysis: pandas, numpy  
- Visualization: seaborn, matplotlib, plotly  
- Database Interaction: sqlalchemy, Jupyter %sql magic  
- ETL & Data Preparation: обработка данных, очистка, работа с выбросами
  
SQL (PostgreSQL):  
- CTE (with)  
- Temp Tables  
- Subqueries  
- Window Functions  
- Aggregate Functions  
- Percentiles (percentile_cont)  
- Data Filtering & Transformation  
- Conditions  
- Converting Data Types
  
BI / Visualization:  
- Metabase: построение графиков / визуализация RFM-сегментов  
